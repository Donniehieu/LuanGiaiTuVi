
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Xem Tử Vi Bắc Phái</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="amlich-convert.js"></script>
    

</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center" id="form-row">
            <div class="col-lg-6">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white text-center">
                        <h2 class="mb-0">Xem Tử Vi Bắc Phái</h2>
                    </div>
                    <div class="card-body">
                        <form id="form_tuvi">
                            <div class="mb-3">
                                <label for="hoten" class="form-label">Họ tên</label>
                                <input type="text" class="form-control" id="hoten" placeholder="Nhập họ tên">
                            </div>
                            <div class="row mb-3">
                                <div class="col">
                                    <label for="ngay" class="form-label">Ngày sinh</label>
                                    <input type="number" class="form-control" id="ngay" min="1" max="31" required>
                                </div>
                                <div class="col">
                                    <label for="thang" class="form-label">Tháng sinh</label>
                                    <input type="number" class="form-control" id="thang" min="1" max="12" required>
                                </div>
                                <div class="col">
                                    <label for="nam" class="form-label">Năm sinh</label>
                                    <input type="number" class="form-control" id="nam" min="1900" max="2100" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="gio" class="form-label">Giờ sinh</label>
                                <select class="form-select" id="gio">
                                    <option value="Tý">Tý (23h-1h)</option>
                                    <option value="Sửu">Sửu (1h-3h)</option>
                                    <option value="Dần">Dần (3h-5h)</option>
                                    <option value="Mão">Mão (5h-7h)</option>
                                    <option value="Thìn">Thìn (7h-9h)</option>
                                    <option value="Tỵ">Tỵ (9h-11h)</option>
                                    <option value="Ngọ">Ngọ (11h-13h)</option>
                                    <option value="Mùi">Mùi (13h-15h)</option>
                                    <option value="Thân">Thân (15h-17h)</option>
                                    <option value="Dậu">Dậu (17h-19h)</option>
                                    <option value="Tuất">Tuất (19h-21h)</option>
                                    <option value="Hợi">Hợi (21h-23h)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="gioitinh" class="form-label">Giới tính</label>
                                <select class="form-select" id="gioitinh">
                                    <option value="Nam">Nam</option>
                                    <option value="Nữ">Nữ</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="namxemhan" class="form-label">Năm xem hạn</label>
                                <input type="number" class="form-control" id="namxemhan" min="1900" max="2100" required>
                            </div>
                            <div class="mb-3">
                                <button type="submit" id="btn_xemtuvi" class="btn btn-success w-100" disabled>Xem tử vi</button>
                            </div>
                        </form>
                        <div id="amlich" class="alert alert-info d-none"></div>
                        <div id="ketqua" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Lá số tử vi -->
        <div class="row justify-content-center d-none" id="laso-row">
            <div class="col-auto">
                <div class="laso-wrapper mt-5" style="position:relative;">
                    <svg id="lasoSvgOverlay" style="position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:10;"></svg>
                    <div class="laso-grid" id="lasoGrid">

                        <!-- Hàng 1 -->
                        <div class="laso-cell cell1">Tỵ</div>
                        <div class="laso-cell cell2">Ngọ</div>
                        <div class="laso-cell cell3">Mùi</div>
                        <div class="laso-cell cell4">Thân</div>
                        <!-- Hàng 2 -->
                        <div class="laso-cell cell5">Thìn</div>
                        <div class="laso-cell center" id="cungGop">
                            <!-- JS sẽ điền thông tin -->
                        </div>
                        <div class="laso-cell cell8">Dậu</div>
                        <!-- Hàng 3 -->
                        <div class="laso-cell cell9">Mão</div>
                        <div class="laso-cell cell12">Tuất</div>
                        <!-- Hàng 4 -->
                        <div class="laso-cell cell13">Dần</div>
                        <div class="laso-cell cell14">Sửu</div>
                        <div class="laso-cell cell15">Tý</div>
                        <div class="laso-cell cell16">Hợi</div>
                    </div>
                    <div id="screenshotResult" style="margin-top:20px;text-align:center"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cucSo = 0;
        let IDTieuHan = 0;
        let cungCu = "";

        document.getElementById('form_tuvi').addEventListener('input', function () {
            const hoten = document.getElementById('hoten').value.trim();
            const ngay = document.getElementById('ngay').value;
            const thang = document.getElementById('thang').value;
            const nam = document.getElementById('nam').value;
            const namxemhan = document.getElementById('namxemhan').value;
            // Chỉ enable nếu hợp lệ ngày tháng năm (được validate ở trên)
            validateDateInput();
        });

        // hàm thực hiện khi bấm nút
        document.getElementById('form_tuvi').addEventListener('submit', function (e) {
            e.preventDefault();

            const hoten = document.getElementById('hoten').value.trim();
            const ngay = parseInt(document.getElementById('ngay').value);
            const thang = parseInt(document.getElementById('thang').value);
            const nam = parseInt(document.getElementById('nam').value);
            const gio = document.getElementById('gio').value;
            const gioitinh = document.getElementById('gioitinh').value;
            const namxemhan = parseInt(document.getElementById('namxemhan').value);

            if (typeof getCanChiFull !== "function") {
                document.getElementById('cungGop').innerHTML = '<div class="text-danger">Không tìm thấy thư viện amlich-convert.js. Vui lòng kiểm tra lại đường dẫn và tải trang.</div>';
                document.getElementById('laso-row').classList.remove('d-none');
                return;
            }
            const kq = getCanChiFull(ngay, thang, nam, gio.split(' ')[0]);
            const am = kq.amlich;
            const canchi = kq.canchi;

            // Năm xem hạn (dương lịch)
            const CAN = ["G.", "Ấ.", "B.", "Đ.", "M.", "K.", "C.", "T.", "N.", "Q."];
            const CHI = ["Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi", "Thân", "Dậu", "Tuất", "Hợi"];
            const canchiNamXemHan = CAN[(namxemhan - 4) % 10] + " " + CHI[(namxemhan - 4) % 12];
            const tuoiAm = namxemhan - am.nam + 1;
            const chiNamXemhan = CHI[(namxemhan - 4) % 12];

            // --- TÍCH HỢP ÂM DƯƠNG, MỆNH, CỤC ---
            const canNam = canchi.nam.split(' ')[0];
            const chiNam = canchi.nam.split(' ')[1];
            const amduong = tinhAmDuong(gioitinh, canNam);
            const menh = traMenh(canNam, chiNam);
            ThienCanNamSinh = canNam;
            // Xác định vị trí cung Mệnh
            const menhObj = getMenhCell(am.thang, gio.split(' ')[0]);
            const chiMenh = menhObj.chi;
            const cellMenh = menhObj.cell;


            // Xác định cung thân
            const thanObj = getThanCell(am.thang, gio.split(' ')[0]);
            const chiThan = thanObj.chi;
            const cellThan = thanObj.cell;
            document.getElementById('cungGop').innerHTML += `<div><b>Cung Thân:</b> ${chiThan}</div>`;

            hienThiTenCungLaso(IDCungMenh, cellThan);
            // Tính Cục
            const cuc = traCuc(canNam, chiMenh);
            // An đại vận
            cucSo = tinhcucSo(cuc);

            // An Sao tử vi

            const idxTuVi = anSaoTuVi(am.ngay, cucSo);

            displayChinhTinhOnLaSo(idxTuVi);

            // 1. Xác định vị trí Thiên Phủ
            const idxThienPhu = viTriThienPhu(idxTuVi);

            // 2. An các sao từ Thiên Phủ
            const saoTuThienPhu = cacSaoTuThienPhu(idxThienPhu);

            rendercacsaotheoThienPhu(saoTuThienPhu, CUNG_CELLS);

            const lsDaiVan = tinhdaivan(IDCungMenh, cucSo, amduong);
            renderDaivan(lsDaiVan);
            // Ví dụ sử dụng sau khi xác định chiNam, tuoiAm, gioitinh
            const arrTieuvan = tinhTieuvan(chiNam, chiNamXemhan, gioitinh);
            renderTieuVan(arrTieuvan);
           
            // khi render: với mỗi cell ứng với CUNG_CELLS[i], chèn arrTieuvan[i] ở góc trái dưới cùng
           
            anNguyetHan(IDTieuHan, am.thang, canchi.gio.split(' ')[1]);
   
            const thangSinhSaoIdx = anSaoTheoThangSinh(am.thang, IDCungMenh);

       
            const gioSinhSaoIdx = anSaoTheoGioSinh(gio.split(' ')[0]);

          
            const gio_sinh_chi = canchi.gio.split(' ')[1];
            anSaoHoaLinhTinh(chiNam, gioitinh, canNam, gio_sinh_chi);

            function anSaoTheoNgaySinh(ngay_am, saoThangSinhIdx, saoGioSinhIdx) {
                // Xóa nhãn cũ nếu có
                document.querySelectorAll('.laso-cell').forEach(cell => {
                    cell.querySelectorAll('.sao-tam-thai, .sao-bat-toa, .sao-thien-quy, .sao-an-quang').forEach(e => e.remove());
                });

                // Tam Thai (sao tốt, hành kim)
                if (typeof saoThangSinhIdx.taPhu === 'number') {
                    let idx = (saoThangSinhIdx.taPhu + (ngay_am - 1)) % 12;
                    let cellNum = CUNG_CELLS[idx].cell;
                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        cell.insertAdjacentHTML('beforeend',
                            `<div class="sao-tam-thai sao-tot hanh-thuy phu-tinh">
                                                                                        Tam Thai
                                                                                    </div>`);
                    }
                }

                // Bát Tọa (sao tốt, hành mộc)
                if (typeof saoThangSinhIdx.huuBat === 'number') {
                    let idx = (saoThangSinhIdx.huuBat - (ngay_am - 1) + 12 * 3) % 12;
                    let cellNum = CUNG_CELLS[idx].cell;
                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        cell.insertAdjacentHTML('beforeend',
                            `<div class="sao-bat-toa sao-tot hanh-moc phu-tinh">
                                                                                        Bát Tọa
                                                                                    </div>`);
                    }
                }

                // Thiên Quý (sao tốt, hành thổ)
                if (typeof saoGioSinhIdx.vanKhuc === 'number') {
                    let idx = (saoGioSinhIdx.vanKhuc - (ngay_am - 2) + 12 * 3) % 12;
                    let cellNum = CUNG_CELLS[idx].cell;
                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        cell.insertAdjacentHTML('beforeend',
                            `<div class="sao-thien-quy sao-tot hanh-tho phu-tinh">
                                                                                        Thiên Quý
                                                                                    </div>`);
                    }
                }

                // Ân Quang (sao tốt, hành mộc)
                if (typeof saoGioSinhIdx.vanXuong === 'number') {
                    let idx = (saoGioSinhIdx.vanXuong + (ngay_am - 2) + 12 * 3) % 12;
                    let cellNum = CUNG_CELLS[idx].cell;
                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        cell.insertAdjacentHTML('beforeend',
                            `<div class="sao-an-quang sao-tot hanh-moc phu-tinh">
                                                                                        Ân Quang
                                                                                    </div>`);
                    }
                }
            }
            anSaoTheoNgaySinh(
                am.ngay,
                { taPhu: thangSinhSaoIdx.taPhuIdx, huuBat: thangSinhSaoIdx.huuBatIdx },
                { vanXuong: gioSinhSaoIdx.vanXuongIdx, vanKhuc: gioSinhSaoIdx.vanKhucIdx }
            );

            hienThiLocTonKinhDuongDaLa(IDCungMenh, canNam);
            hienThiSaoCoDinh(IDCungMenh);
            // Xác định vị trí Lộc Tồn
            const locTonIdx = viTriLocTon(canNam);
            // An vòng Lộc Tồn 12 sao
            anVongLocTon12Sao(locTonIdx, amduong, CUNG_CELLS);
            // An Văn Tinh, Đường Phù, Quốc Ấn
            anVanTinhDuongPhuQuocAn(locTonIdx, CUNG_CELLS);
            // An Khôi Việt Lưu Hà
            anSaoThienKhoiVietLuuHa(canNam);
            // An sao vòng Thái Tuế
            anVongThaiTueVaKem(chiNam);
            anSaoThienKhoc(chiNam);
            // An Hoa cái  Đào hoa, Thiên mã, Kiếp sát
            anHoaCaiDaoHoaThienMaKiepSat(chiNam);
            // An sao Hồng Loan, Thiên Hỷ, Phượng Các
            anHongLoanThienHyPhuongCacGiaiThan(chiNam);
            // An sao Cô Thần, Quả Tú
            anCoThanQuaTu(chiNam);
            // An sao Phá toái
            anPhaToai(chiNam);
            // An sao Thiên Tài Thiên Thọ
            anThienTaiThienTho(chiNam, chiMenh, chiThan);
            // An Đẩu Quân
            anDauQuan(chiNam, am.thang, canchi.gio.split(' ')[1]);
            // An vòng Trường Sinh
            anVongTrangSinh(cuc, amduong);
            // An sao tứ Hoá

            // Sao chính tinh từ Tử Vi
            const posChinh = getChinhTinhFromTuVi(idxTuVi);
            const cuCungSao = {};
            // Sao chính tinh
            cuCungSao["Tử Vi"] = posChinh.tuVi - 1;
            cuCungSao["Thiên Cơ"] = posChinh.thienCo - 1;
            cuCungSao["Thái Dương"] = posChinh.thaiDuong - 1;
            cuCungSao["Vũ Khúc"] = posChinh.vuKhuc - 1;
            cuCungSao["Thiên Đồng"] = posChinh.thienDong - 1;
            cuCungSao["Liêm Trinh"] = posChinh.liemTrinh - 1;
            // Sao phụ tinh
            const phuTinhMap = {
                thienPhu: "Thiên Phủ",
                thaiAm: "Thái Âm",
                thamLang: "Tham Lang",
                cuMon: "Cự Môn",
                thienTuong: "Thiên Tướng",
                thienLuong: "Thiên Lương",
                thatSat: "Thất Sát",
                phaQuan: "Phá Quân"
            };
            for (const [k, v] of Object.entries(saoTuThienPhu)) {
                if (phuTinhMap[k]) cuCungSao[phuTinhMap[k]] = v - 1;
            }
            // Tả Phụ, Hữu Bật, Văn Xương, Văn Khúc, ...
            if (typeof idx_taPhu === "number") cuCungSao["Tả Phụ"] = idx_taPhu;
            if (typeof idx_huuBat === "number") cuCungSao["Hữu Bật"] = idx_huuBat;
            if (typeof idx_vanXuong === "number") cuCungSao["Văn Xương"] = idx_vanXuong;
            if (typeof idx_vanKhuc === "number") cuCungSao["Văn Khúc"] = idx_vanKhuc;

            anSaoTuHoa(canNam, cuCungSao);
            // An Triệt
            anTriet(canNam);
            // An Tuần
            anTuan(canNam, chiNam);
            // An sao lưu  theo Năm xem
            anSaoLuuTheoNamXem(chiNamXemhan);
            // An sao lưu Lộc Tồn
            anLuuLocTon(canchiNamXemHan.split(' ')[0]);
            // An sao Lưu Kình -Đà
            anLuuKinhDuongDaLa(canchiNamXemHan.split(' ')[0]);
            // An sao lưu tứ hoá


            // Gọi hàm an sao lưu tứ hóa
            anSaoLuuTuHoa(canchiNamXemHan.split(' ')[0], cuCungSao);
            // An đại vận sao
            let daiVanArr = [];

            for (let i = 0; i < 12; ++i) daiVanArr.push(cucSo + i * 10);
            function getCungDaiVanHienTai(daiVanArr, tuoiHienTai) {
                for (let i = 0; i < 12; ++i) {
                    let start = daiVanArr[i];
                    let end = daiVanArr[(i + 1) % 12];
                    if (i < 11 && tuoiHienTai >= start && tuoiHienTai < end) {
                        return i + 1;
                    }
                    // Nếu là cung cuối cùng
                    if (i === 11 && tuoiHienTai >= start) {
                        return i + 1;
                    }
                }
                return -1; // Không tìm thấy
            }

            let idxCungDaiVan = getCungDaiVanHienTai(daiVanArr, tuoiAm);

            let tenCungDaiVan = CUNG_CELLS[idxCungDaiVan].chi;


            let canCung = getCanThang12Cung(ThienCanNamSinh)[idxCungDaiVan];

            // ====== Hàm xác định vị trí Lộc Tồn đại vận dựa theo can đại vận hiện tại (vòng Lộc Tồn, bỏ tứ mộ) ======
            const VONG_LOC_TON_CUNG = ["Dần", "Mão", "Tỵ", "Ngọ", "Tỵ", "Ngọ", "Thân", "Dậu", "Hợi", "Tý"];
            const VONG_LOC_TON_CAN = ["G.", "Ấ.", "B.", "Đ.", "M.", "K.", "C.", "T.", "N.", "Q."]; // Giáp, Ất, Bính, Đinh, ...

            /**
             * Trả về tên cung ứng với can đại vận hiện tại theo vòng Lộc Tồn
             * @param {string} canDaiVan - Thiên can ký hiệu ("G.","Ấ.","B.","Đ.","M.","K.","C.","T.","N.","Q.")
             * @returns {string|null} - Tên cung Lộc Tồn đại vận ("Dần", "Mão", "Tỵ", "Ngọ", "Thân", "Dậu") hoặc null nếu không hợp lệ
             */
            function viTriLocTonDaiVan(canDaiVan) {
                // Chỉ 6 can đầu tiên ứng với 6 cung vòng Lộc Tồn (Giáp~Kỷ)
                const idx = VONG_LOC_TON_CAN.indexOf(canDaiVan);
                if (idx === -1) return null;
                return VONG_LOC_TON_CUNG[idx];
            }


            /**
             * Tìm vị trí các sao đại vận vòng Lộc Tồn dựa trên can đại vận hiện tại
             * @param {string} canDaiVan - Thiên can cung đại vận hiện tại ("G.","Ấ.",...)
             * @param {object[]} cungCells - Mảng CUNG_CELLS từ code dự án, mỗi phần tử {cell, chi}
             * @returns {object} - {locTon: idx, kinhDuong: idx, daLa: idx, tenCungLocTon: string}
             */
            function viTriSaoDaiVanVongLocTon(canDaiVan, cungCells) {
                // Lấy tên cung Lộc Tồn đại vận
                const tenCungLocTon = viTriLocTonDaiVan(canDaiVan);
                if (!tenCungLocTon) return { locTon: null, kinhDuong: null, daLa: null, tenCungLocTon: null };

                // Tìm index trong mảng CUNG_CELLS
                const idxLocTon = cungCells.findIndex(c => c.chi === tenCungLocTon);

                // Kình Dương: từ Lộc Tồn tiến 1 cung thuận vòng Bắc phái
                const idxKinhDuong = (idxLocTon + 1) % 12;
                // Đà La: từ Lộc Tồn lùi 1 cung nghịch vòng Bắc phái
                const idxDaLa = (idxLocTon + 11) % 12;

                return {
                    locTon: idxLocTon,       // index trong CUNG_CELLS
                    kinhDuong: idxKinhDuong, // index trong CUNG_CELLS
                    daLa: idxDaLa,           // index trong CUNG_CELLS
                    tenCungLocTon
                };
            }

            /**
             * Hiển thị các sao đại vận Lộc Tồn, Kình Dương, Đà La lên bàn lá số
             * @param {object} saoDaiVan - Đối tượng trả về từ viTriSaoDaiVanVongLocTon
             * @param {object[]} cungCells - Mảng CUNG_CELLS từ code dự án, mỗi phần tử {cell, chi}
             */
            function hienThiSaoDaiVanVongLocTon(saoDaiVan, cungCells) {
                // Xoá nhãn cũ nếu có
                document.querySelectorAll('.laso-cell').forEach(cell => {
                    cell.querySelectorAll('.saodv-loc-ton, .saodv-kinh-duong, .saodv-da-la').forEach(e => e.remove());
                });

                // Lộc Tồn đại vận
                if (saoDaiVan.locTon !== null) {
                    let cellNum = cungCells[saoDaiVan.locTon].cell;

                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        cell.insertAdjacentHTML('afterbegin',
                            `<div class="saodv-loc-ton sao-tot hanh-tho phu-tinh" style="text-align:left;">
                                                           Lộc Tồn (ĐV)
                                                       </div>`);
                    }
                }
                // Kình Dương đại vận
                if (saoDaiVan.kinhDuong !== null) {
                    let cellNum = cungCells[saoDaiVan.kinhDuong].cell;

                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        cell.insertAdjacentHTML('afterbegin',
                            `<div class="saodv-kinh-duong sao-xau hanh-kim phu-tinh" style="text-align:left;">
                                                           Kình Dương (ĐV)
                                                       </div>`);
                    }
                }
                // Đà La đại vận
                if (saoDaiVan.daLa !== null) {
                    let cellNum = cungCells[saoDaiVan.daLa].cell;

                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        cell.insertAdjacentHTML('afterbegin',
                            `<div class="saodv-da-la sao-xau hanh-kim phu-tinh" style="text-align:left;">
                                                           Đà La (ĐV)
                                                       </div>`);
                    }
                }
            }

            // ====== Hàm workflow tổng hợp cho đại vận (gọi hàm này khi cần render đại vận lên lá số) ======
            /**
             * Gọi hàm này sau khi đã xác định idxCungDaiVan và mảng can 12 cung (thứ tự theo CUNG_CELLS)
             * @param {number} idxCungDaiVan - index cung đại vận hiện tại (0~11, trong CUNG_CELLS)
             * @param {string[]} can12Cung - mảng 12 thiên can cho 12 cung, thứ tự khớp CUNG_CELLS
             * @param {object[]} cungCells - Mảng CUNG_CELLS từ code dự án
             */
            function renderDaiVanSaoLocTonKinhDuongDaLa(idxCungDaiVan, can12Cung, cungCells) {
                // Lấy can đại vận hiện tại

                // Lấy vị trí các sao đại vận
                let saoDaiVan = viTriSaoDaiVanVongLocTon(canCung, cungCells);
                // Hiển thị lên bàn lá số
                hienThiSaoDaiVanVongLocTon(saoDaiVan, cungCells);
            }

            renderDaiVanSaoLocTonKinhDuongDaLa(idxCungDaiVan, lsDaiVan, CUNG_CELLS);
            // ==== Xác định vị trí sao Thiên Khôi và Thiên Việt Đại Vận ====
            // Bảng tra theo Bắc phái

            const MAP_KHOI_VIET = {
                "G.": { khoi: "Sửu", viet: "Mùi" },      // Giáp
                "Ấ.": { khoi: "Tý", viet: "Thân" },      // Ất
                "B.": { khoi: "Hợi", viet: "Dậu" },      // Bính
                "Đ.": { khoi: "Hợi", viet: "Dậu" },      // Đinh
                "M.": { khoi: "Sửu", viet: "Mùi" },      // Mậu
                "K.": { khoi: "Tý", viet: "Thân" },      // Kỷ
                "C.": { khoi: "Ngọ", viet: "Dần" },      // Canh
                "T.": { khoi: "Ngọ", viet: "Dần" },      // Tân
                "N.": { khoi: "Mão", viet: "Tỵ" },       // Nhâm
                "Q.": { khoi: "Mão", viet: "Tỵ" },       // Quý
            };

            /**
             * Xác định vị trí Thiên Khôi và Thiên Việt đại vận trên CUNG_CELLS
             * @param {string} canDaiVan - Thiên can cung đại vận hiện tại ("G.","Ấ.",...)
             * @param {object[]} cungCells - Mảng CUNG_CELLS: [{chi: "Dần", ...}, ...]
             * @returns {object} - {khoi: idx, viet: idx, tenCungKhoi: string, tenCungViet: string}
             */
            function viTriKhoiVietDaiVan(canDaiVan, cungCells) {
                const entry = MAP_KHOI_VIET[canDaiVan];
                if (!entry) return { khoi: null, viet: null, tenCungKhoi: null, tenCungViet: null };
                const idxKhoi = cungCells.findIndex(c => c.chi === entry.khoi);
                const idxViet = cungCells.findIndex(c => c.chi === entry.viet);
                return {
                    khoi: idxKhoi,
                    viet: idxViet,
                    tenCungKhoi: entry.khoi,
                    tenCungViet: entry.viet
                };
            }

            const viTriKVDV = viTriKhoiVietDaiVan(canCung, CUNG_CELLS);
            function hienThiKhoiVietDaiVan(viTriKV, cungCells) {
                // Xoá nhãn cũ nếu có
                document.querySelectorAll('.laso-cell').forEach(cell => {
                    cell.querySelectorAll('.saodv-thien-khoi, .saodv-thien-viet').forEach(e => e.remove());
                });

                // Thiên Khôi đại vận
                if (viTriKV.khoi !== null && viTriKV.khoi !== -1) {
                    let cellNum = cungCells[viTriKV.khoi].cell;
                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        cell.insertAdjacentHTML('afterbegin',
                            `<div class="saodv-thien-khoi sao-tot hanh-hoa phu-tinh" style="text-align:left;">
                                                                    Thiên Khôi (ĐV)
                                                                </div>`);
                    }
                }

                // Thiên Việt đại vận
                if (viTriKV.viet !== null && viTriKV.viet !== -1) {
                    let cellNum = cungCells[viTriKV.viet].cell;
                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        cell.insertAdjacentHTML('afterbegin',
                            `<div class="saodv-thien-viet sao-tot hanh-hoa phu-tinh" style="text-align:left;">
                                                                    Thiên Việt (ĐV)
                                                                </div>`);
                    }
                }
            }
            hienThiKhoiVietDaiVan(viTriKVDV, CUNG_CELLS);

            // ==== Xác định vị trí sao Thiên Mã Đại Vận - ĐÚNG quy tắc truyền thống ====

            // Tam hợp
            const TAM_HOP_CHI = [
                ["Dần", "Ngọ", "Tuất"],    // Hỏa
                ["Thân", "Tý", "Thìn"],    // Thủy
                ["Tỵ", "Dậu", "Sửu"],      // Kim
                ["Hợi", "Mão", "Mùi"],     // Mộc
            ];

            // Đối xung 12 địa chi
            const DOI_XUNG_CHI = {
                "Tý": "Ngọ", "Sửu": "Mùi", "Dần": "Thân", "Mão": "Dậu",
                "Thìn": "Tuất", "Tỵ": "Hợi", "Ngọ": "Tý", "Mùi": "Sửu",
                "Thân": "Dần", "Dậu": "Mão", "Tuất": "Thìn", "Hợi": "Tỵ"
            };

            /**
             * Xác định cung Thiên Mã đại vận (chuẩn truyền thống)
             * @param {string} chiDaiVan - Địa chi cung đại vận hiện tại ("Dần", "Thân", ...)
             * @param {object[]} cungCells - Mảng CUNG_CELLS: [{chi: "Dần", ...}, ...]
             * @returns {object} - {thienMa: idx, tenCungThienMa: string}
             */
            function viTriThienMaDaiVan(chiDaiVan, cungCells) {
                // Tìm nhóm tam hợp chứa chi hiện tại
                let foundGroup = null;
                for (const group of TAM_HOP_CHI) {
                    if (group.includes(chiDaiVan)) {
                        foundGroup = group;
                        break;
                    }
                }
                if (!foundGroup) return { thienMa: null, tenCungThienMa: null };

                // Chi đầu tiên của tam hợp
                const chiDau = foundGroup[0];
                // Lấy chi đối xung với chi đầu
                const chiThienMa = DOI_XUNG_CHI[chiDau];

                // Tìm index trong mảng CUNG_CELLS
                const idxThienMa = cungCells.findIndex(c => c.chi === chiThienMa);

                return {
                    thienMa: idxThienMa,
                    tenCungThienMa: chiThienMa
                };
            }

            const vitriDV_Thiên_Mã = viTriThienMaDaiVan(tenCungDaiVan, CUNG_CELLS);

            function hienThiThienMaDaiVan(viTriTM, cungCells) {
                // Xoá nhãn cũ nếu có
                document.querySelectorAll('.laso-cell').forEach(cell => {
                    cell.querySelectorAll('.saodv-thien-ma').forEach(e => e.remove());
                });

                // Thiên Mã đại vận
                if (viTriTM.thienMa !== null && viTriTM.thienMa !== -1) {
                    let cellNum = cungCells[viTriTM.thienMa].cell;
                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        cell.insertAdjacentHTML('afterbegin',
                            `<div class="saodv-thien-ma sao-tot hanh-hoa phu-tinh" style="text-align:left;">
                                                                    Thiên Mã (ĐV)
                                                                </div>`);
                    }
                }
            }

            function getAllStarsInCells() {
                // Các class selector chứa sao (mỗi selector nên lấy đúng các sao bạn đã an)
                const saoSelectors = [

                    '.sao-tot',
                    '.sao-xau',
                    '.chinh-tinh'
                    // ... bổ sung nếu bạn có thêm class cho các loại sao khác
                ];

                let result = [];
                for (let i = 0; i < 12; ++i) {
                    const cellNum = CUNG_CELLS[i].cell;
                    const cell = document.querySelector('.cell' + cellNum);
                    if (!cell) continue;
                    let saoList = [];
                    saoSelectors.forEach(sel => {
                        cell.querySelectorAll(sel).forEach(e => {
                            let ten = e.innerText.trim();
                            let cls = e.className.trim();
                            if (ten) {
                                // Tránh lặp lại cùng tên - class (nếu cần)
                                if (!saoList.some(obj => obj.ten === ten && obj.class === cls))
                                    saoList.push({ ten: ten, class: cls });
                            }
                        });
                    });
                    result.push({
                        chi: CUNG_CELLS[i].chi,
                        cellNum: cellNum,
                        sao: saoList
                    });
                }
                return result;
            }
            const danhSachSao = getAllStarsInCells();

            console.log(danhSachSao);
            hienThiThienMaDaiVan(vitriDV_Thiên_Mã, CUNG_CELLS);
            // Bảng tứ hóa đại vận theo bài thơ (Bắc phái)
            const TU_HOA_DAI_VAN = {
                "G.": ["Liêm Trinh", "Phá Quân", "Vũ Khúc", "Thái Dương"],        // Giáp
                "Ấ.": ["Thiên Cơ", "Thiên Lương", "Tử Vi", "Thái Âm"],           // Ất
                "B.": ["Thiên Đồng", "Thiên Cơ", "Văn Xương", "Liêm Trinh"],      // Bính
                "Đ.": ["Thái Âm", "Thiên Đồng", "Thiên Cơ", "Cự Môn"],            // Đinh
                "M.": ["Tham Lang", "Thái Âm", "Hữu Bật", "Thiên Cơ"],            // Mậu
                "K.": ["Vũ Khúc", "Tham Lang", "Thiên Lương", "Văn Khúc"],        // Kỷ
                "C.": ["Thái Dương", "Vũ Khúc", "Thái Âm", "Thiên Đồng"],         // Canh
                "T.": ["Cự Môn", "Thái Dương", "Văn Khúc", "Văn Xương"],          // Tân
                "N.": ["Thiên Lương", "Tử Vi", "Tả Phụ", "Vũ Khúc"],              // Nhâm
                "Q.": ["Phá Quân", "Cự Môn", "Thái Âm", "Tham Lang"],             // Quý
            };

            const TU_HOA_LABELS = ["Hóa Lộc", "Hóa Quyền", "Hóa Khoa", "Hóa Kỵ"];

            // Ngũ hành của các sao chủ hóa theo truyền thống (bạn có thể chỉnh lại cho phù hợp quy chuẩn của dự án)


            const HANH_CLASS = {
                "kim": "hanh-kim",
                "moc": "hanh-moc",
                "thuy": "hanh-thuy",
                "hoa": "hanh-hoa",
                "tho": "hanh-tho",
            };

            /**
             * An tứ hóa đại vận lên bàn lá số, gán class tốt/xấu và ngũ hành đúng từng sao hóa
             * @param {string} canDaiVan - Thiên can cung đại vận hiện tại ("G.","Ấ.",...)
             * @param {object[]} cungCells - Mảng CUNG_CELLS: [{cell, chi, sao: [{name, ...}, ...]}, ...]
             */
            // Các nhãn hóa

            // Ngũ hành cho hóa đại vận (chuẩn Bắc phái)
            const NGU_HANH_HOA_SAO = {
                "Hóa Lộc": "moc",
                "Hóa Quyền": "moc",
                "Hóa Khoa": "moc",
                "Hóa Kỵ": "thuy"
            };


            /**
             * Hiển thị hóa Lộc, Quyền, Khoa, Kỵ đại vận lên lá số (theo can đại vận)
             * @param {string} canDaiVan - Thiên can đại vận ("G.", "B.",...)
             * @param {object[]} cungCells - Danh sách cung trên lá số, mỗi cung có .cell hoặc .cellNum, .sao (mảng sao)
             */
            function hienThiTuHoaDaiVan(canDaiVan, cungCells) {
                const hoaArr = TU_HOA_DAI_VAN[canDaiVan];
                if (!hoaArr) return;

                // Xoá nhãn cũ
                document.querySelectorAll('.laso-cell').forEach(cell => {
                    cell.querySelectorAll('.saodv-tu-hoa').forEach(e => e.remove());
                });

                for (const cung of cungCells) {
                    if (!cung.sao) continue;
                    for (const sao of cung.sao) {
                        const tenSao = sao.ten || sao.name;
                        const idx = hoaArr.indexOf(tenSao);
                        if (idx !== -1) {
                            const label = TU_HOA_LABELS[idx];
                            // Xác định tốt/xấu
                            const isTot = idx < 3; // Lộc, Quyền, Khoa là tốt, Kỵ là xấu
                            // Ngũ hành hóa
                            const hanh = NGU_HANH_HOA_SAO[label] || "tho";
                            const hanhClass = HANH_CLASS[hanh];
                            // Lấy DOM cell
                            let cell = document.querySelector('.cell' + (cung.cellNum || cung.cell));
                            if (cell) {
                                cell.insertAdjacentHTML('beforeend',
                                    `<div class="saodv-tu-hoa ${isTot ? "sao-tot" : "sao-xau"} ${hanhClass} phu-tinh"
                                                                    style="font-weight:bold;font-size:13px;text-align:left;white-space:pre-line;">
                                                                        (${label} - ĐV)
                                                                    </div>`);
                            }
                        }
                    }
                }
            }
            hienThiTuHoaDaiVan(canCung, danhSachSao);
            // Gọi sau khi an sao xong:
            groupAndArrangeStars();
            arrangeGoodBadStarsInCells();
            const hanhMenh = layNguHanhMenh60(menh);
            const hanhCuc = layNguHanhCuc(cuc);
            const kqSinhKhac = xetSinhKhacNguHanh(hanhMenh, hanhCuc);
            const Quan_he_cucmenh = hienHuongCo(kqSinhKhac);

            namtuoi = soCuoiNamSinh(am.nam);
            const am_duong_tinh_chat = amDuongThuanNghichLy(namtuoi, chiMenh);
            const chiGio = canchi.gio.split(' ')[1];

            phamgio_quan_sat = checkGioPhamQuanSat(am.thang, chiGio);
            phamgio_diem_vuong = checkGioDiemVuong(am.thang, chiGio);
            phamgio_da_de = checkGioDaDe(am.thang, chiGio);
            phamgio_tuong_quan = checkGioTuongQuan(am.thang, chiGio);
            phamgio_kim_xa_thiet_toa = checkGioKimXaThietToa(chiNam, am.thang, am.ngay, chiGio, gioitinh);

            document.getElementById('cungGop').innerHTML = `
                                                                                                <div><b>Người xem hạn:</b> ${hoten} </div>
                                                                                                <div><b>Giới tính :</b> ${gioitinh} </div>
                                                                                                <div><b>Năm xem hạn:</b> ${namxemhan} (${canchiNamXemHan})</div>
                                                                                                <div><b>Sinh âm lịch:</b> ${am.ngay}/${am.thang}${am.nhuan ? ' (Nhuận)' : ''}/${am.nam}</div>
                                                                                                <div><b>Năm sinh: ${canchi.nam} Tháng sinh: ${canchi.thang} </b> </div>
                                                                                                <div><b> Ngày sinh: ${canchi.ngay} Giờ sinh: ${canchi.gio}</b> </div>
                                                                                                <div><b> Số tuổi âm:</b> ${tuoiAm} Tuổi</div>
                                                                                                <hr/>
                                                                                                <div><b>Âm dương:</b> ${amduong}</div>
                                                                                                <div><b>Mệnh:</b> ${menh}</div>
                                                                                                <div><b>Cục:</b> ${cuc}</div>
                                                                                                <div><b> ${Quan_he_cucmenh}</b></div>
                                                                                                <div><b> Thân cư ${cungCu}</b></div>
                                                                                                <div><b>${am_duong_tinh_chat}</b></div>
                                                                                                <hr/>
                                                                                                <div><b>${phamgio_quan_sat}</b></div>
                                                                                                <div><b>${phamgio_diem_vuong}</b></div>
                                                                                                <div><b>${phamgio_da_de}</b></div>
                                                                                                <div><b>${phamgio_tuong_quan}</b></div>
                                                                                                <div><b>${phamgio_kim_xa_thiet_toa}</b></div>


                                                                                            `;
            document.getElementById('form-row').classList.add('d-none');
            document.getElementById('laso-row').classList.remove('d-none');
            setTimeout(function () {
                drawTamHopByMenhIdx(IDCungMenh);
                chupVaShowBanLaSo();
            }, 20);

        });



    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>

        document.addEventListener('DOMContentLoaded', function () {
            var zoom = Math.round((window.outerWidth / window.innerWidth) * 100);
            if (zoom !== 100) {
                alert('Trình duyệt của bạn đang để zoom khác 100%. Vui lòng bấm Ctrl+0 để xem ứng dụng đúng chuẩn!');
            }
        });
    </script>

    <script src="ansao.js"></script>
    <script src="kiemtragiosinh.js"></script>
    <script src="veduongtamhop.js"></script>
    <script src="chuplaso.js"></script>
    <script src="nguhanhcucmenh.js"></script>
    <script src="ancanchocung.js"></script>
    <script src="tencung.js"></script>
    <script src="kiemtrathongtin.js"></script>
    <script src="ansaochinhtinh.js"></script>
    <script src="tinhdaitieuvan.js"></script>
    <script src="ansaophutinh.js"></script>
    <script src="ansaoluu.js"></script>
</body>
     
</html>
